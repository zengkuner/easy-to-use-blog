## React Fiber 原理

简单说，**Fiber**是 React 的**任务分片**机制，解决以前渲染大组件时“卡住页面的问题”。它把渲染任务拆成无数小任务，像切土豆片一样，切一片执行一片，中间能暂停去处理更急的事（比如用户点击）。

### 原理核心

#### 1. 旧版问题

以前 React 更新组件是“一口气干到底”（同步渲染），如果组件树很大，会长时间霸占浏览器主线程，导致页面卡死（比如动画卡帧、输入框打字延迟）。

#### 2. Fiber 改进

- **任务拆碎**：把组件更新拆成一个个小任务（每个任务叫一个`Fiber`节点）。
- **可中断+恢复**：干完一个小任务后，React 会问浏览器：“你还有时间嘛？有就继续，没有就先还你主线程处理动画、点击等紧急任务，回头再接着干。”
- **优先级**：区分任务紧急程度（比如用户输入>动画>数据渲染），优先处理高优先级任务。

### 举个栗子

- 旧版：你一口气要搬 100 块砖，中间不能停，搬完才能喝水。
- Fiber 版：把 100 块砖拆成 10 次搬，每次搬 10 块，搬完 10 块就休息一下，看看有没有人喊你喝水、接电话，处理完再继续搬。

### Fiber 的关键实现

- **链表结构**：用链表（而不是递归）遍历组件树，可以随时中断和恢复。
- **双缓存机制**：准备两颗“虚拟 DOM 树”（一个当前显示，一个在后台更新），交替使用，避免渲染一半的中间状态。

### 最终效果

- 页面更流畅（动画、输入不卡）。
- 支持异步渲染（比如先渲染部分内容，再逐步完善）。
- 为大任务（比如复杂动画、大数据量）提供性能兜底。

### 总结

Fiber 是 React 的“时间管理大师”，把任务切碎、排优先级，让浏览器不再卡成狗。
